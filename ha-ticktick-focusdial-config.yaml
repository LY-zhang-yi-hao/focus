# Home Assistant Ã— TickTick Ã— Focus Dial å®Œæ•´é…ç½®æ–¹æ¡ˆ
# ç”Ÿæˆæ—¶é—´ï¼š2025-12-28
# ä½œè€…ï¼šæµ®æµ®é…± Ï†(â‰§Ï‰â‰¦*)â™ª

---
## é…ç½®è¯´æ˜

æ­¤æ–‡ä»¶åŒ…å«å®Œæ•´çš„ HA é…ç½®ï¼ŒåŒ…æ‹¬ï¼š
1. REST Commandï¼šæ¨é€ä»»åŠ¡åˆ—è¡¨åˆ° Focus Dial
2. Input Textï¼šå­˜å‚¨ä»Šæ—¥ç´¯è®¡ç»Ÿè®¡
3. Scriptï¼šç»„è£… TickTick ä»»åŠ¡å¹¶æ¨é€
4. Automationï¼šwebhook æ¥æ”¶äº‹ä»¶ + ç´¯è®¡ç»Ÿè®¡ + å›å†™ TickTickï¼ˆä¸ä½¿ç”¨ python_scriptï¼‰

---
## âœ… æ¨èï¼ˆæ–¹æ¡ˆ 2 ç¨³ï¼‰ï¼šä½¿ç”¨æœ¬ä»“åº“çš„ HA è‡ªå®šä¹‰ç»„ä»¶ï¼ˆå†™å…¥ .storageï¼‰

> é€‚ç”¨ï¼šä½ æƒ³é•¿æœŸç´¯åŠ â€œæ€»å­¦ä¹ æ—¶é•¿â€ï¼Œå¹¶ä¸”å¸Œæœ›è®¾å¤‡é€‰æ‹© YES åä»»åŠ¡ç«‹åˆ»ä»å¾…åŠæ¶ˆå¤±/è¿›å…¥å·²å®Œæˆï¼ŒåŒæ—¶è‡ªåŠ¨åˆ·æ–°å¹¶é‡æ–°æ¨é€åˆ°è®¾å¤‡ã€‚

1) å¤åˆ¶æœ¬ä»“åº“ `custom_components/focus_dial/` åˆ°ä½ çš„ HAï¼š
- HA OS / Supervisedï¼š`/config/custom_components/focus_dial/`

2) åœ¨ `configuration.yaml` æ·»åŠ ï¼š

```yaml
focus_dial:
  device_host: 192.168.15.166
  todo_entity_id: todo.zhuan_zhu
  ticktick_project_id: "69510f448f0805fa66144dc9"
  webhook_id: focus_dial
  default_duration: 25
  max_pending: 20
  max_completed: 20
```

3) é‡å¯ HA åï¼Œå¼€å‘è€…å·¥å…· â†’ æœåŠ¡ â†’ è°ƒç”¨ `focus_dial.push_tasks` å³å¯æ¨é€ä»»åŠ¡åˆ°è®¾å¤‡ã€‚  
ç»Ÿè®¡ä¼šå†™å…¥ `.storage/focus_dial_stats`ï¼ˆä¸ä¼šå— `input_text` 255 é™åˆ¶ï¼‰ã€‚

---
## å‰ç½®æ¡ä»¶

1. âœ… HACS å·²å®‰è£…
2. âœ… Hantick TickTick é›†æˆå·²å®‰è£…å¹¶é…ç½®
3. âœ… Focus Dial å·²é…ç½‘ï¼ˆIP: 192.168.15.166ï¼‰
4. âœ… TickTick OAuth å·²é…ç½®ï¼ˆClient ID & Secretï¼‰
5. âœ… TickTick Project ID å·²ç¡®è®¤ï¼ˆğŸƒä¸“æ³¨æ¸…å•ï¼š`69510f448f0805fa66144dc9`ï¼‰

---
## ç¬¬ä¸€æ­¥ï¼šåˆ›å»º Input Text Helper

åœ¨ HA Web UI åˆ›å»ºï¼š
Settings â†’ Devices & services â†’ Helpers â†’ Create Helper â†’ Text

- Name: Focus Dial Stats Today
- Entity ID: input_text.focus_dial_stats_today
- Initial value: {}
- Max length: 255ï¼ˆ`input_text` ä¸Šé™ï¼‰

æˆ–è€…åœ¨ configuration.yaml æ·»åŠ ï¼š

```yaml
input_text:
  focus_dial_stats_today:
    name: "Focus Dial ä»Šæ—¥ç»Ÿè®¡"
    initial: "{}"
    max: 255
```

---
## ç¬¬äºŒæ­¥ï¼šé…ç½® REST Command

åœ¨ configuration.yaml æ·»åŠ ï¼ˆæˆ–åˆ›å»º rest_command.yaml å¹¶ includeï¼‰ï¼š

```yaml
# æ¨é€ä»»åŠ¡åˆ—è¡¨åˆ° Focus Dial
rest_command:
  focus_dial_push_tasklist:
    url: "http://192.168.15.166/api/tasklist"
    method: POST
    content_type: "application/json"
    payload: >
      {{ tasks_json }}
    timeout: 5
```

---
## ç¬¬ä¸‰æ­¥ï¼šé…ç½® Script

åœ¨ scripts.yaml æ·»åŠ ï¼š

```yaml
focus_dial_send_ticktick_focus_tasks:
  alias: "Focus Dial - æ¨é€ TickTick ğŸƒä¸“æ³¨æ¸…å•ä»»åŠ¡"
  description: "è¯»å– todo.zhuan_zhu çš„ä»»åŠ¡ï¼ˆå«å¾…åŠ/å·²å®Œæˆï¼‰ï¼Œç»„è£… JSON æ¨é€åˆ° Focus Dialï¼ˆä¸åšæ‹¼éŸ³/ASCIIï¼‰"
  mode: single
  sequence:
    - variables:
        stats_entity: "input_text.focus_dial_stats_today"
        stats: "{{ (states(stats_entity) | default('{}')) | from_json | default({}) }}"
        ticktick_entity: "todo.zhuan_zhu"

    - service: todo.get_items
      target:
        entity_id: "{{ ticktick_entity }}"
      response_variable: todo_items_resp

    - variables:
        items: "{{ todo_items_resp[ticktick_entity]['items'] | default([]) }}"
        tasks_json: >
          {
            "tasks": [
              {% set ns = namespace(first=true) %}
              {% for item in items %}
                {% set status = (item.status | default('needs_action') | string) %}
                {% if status in ['needs_action', 'completed'] %}
                  {% set uid = (item.uid | default('') | string) %}
                  {% set name = (item.summary | default('') | string | regex_replace('[\ud800-\udfff]', '')) %}
                  {% if not ns.first %},{% endif %}
                  {% set ns.first = false %}
                  {
                    "id": {{ uid | tojson }},
                    "name": {{ name | tojson }},
                    "display_name": {{ name | tojson }},
                    "status": {{ status | tojson }},
                    "duration": 25,
                    "spent_today_sec": {{ stats.get(uid, 0) | int }}
                  }
                {% endif %}
              {% endfor %}
            ]
          }

    - service: rest_command.focus_dial_push_tasklist
      data:
        tasks_json: "{{ tasks_json }}"

    - service: system_log.write
      data:
        message: "Focus Dial: pushed {{ (tasks_json | from_json).tasks | length }} tasks"
        level: info
```

---
## ç¬¬å››æ­¥ï¼šé…ç½® Automationï¼ˆWebhook + ç»Ÿè®¡ + å›å†™ï¼‰

åœ¨ automations.yaml æ·»åŠ ï¼š

```yaml
# æ¯æ—¥æ¸…ç©ºç»Ÿè®¡
- id: focus_dial_reset_stats_today
  alias: "Focus Dial - æ¯æ—¥æ¸…ç©ºç»Ÿè®¡"
  description: "æ¯å¤© 0 ç‚¹æ¸…ç©ºä»Šæ—¥ç´¯è®¡ç»Ÿè®¡"
  trigger:
    - platform: time
      at: "00:00:00"
  action:
    - service: input_text.set_value
      data:
        entity_id: input_text.focus_dial_stats_today
        value: "{}"

# ï¼ˆå¯é€‰ï¼‰HA å¯åŠ¨åè‡ªåŠ¨æ¨é€ä¸€æ¬¡ä»»åŠ¡åˆ—è¡¨ï¼ˆç¡®ä¿è®¾å¤‡éšæ—¶å¯ç”¨ï¼‰
- id: focus_dial_push_tasks_on_startup
  alias: "Focus Dial - HA å¯åŠ¨åè‡ªåŠ¨æ¨é€ä»»åŠ¡"
  trigger:
    - platform: homeassistant
      event: start
  action:
    - delay: "00:00:20"
    - service: script.focus_dial_send_ticktick_focus_tasks
  mode: single

# ï¼ˆå¯é€‰ï¼‰å‘¨æœŸåˆ·æ–°ä»»åŠ¡åˆ—è¡¨ï¼ˆè®© spent_today_sec æ›´åŠæ—¶ï¼›è®¾å¤‡ç¦»çº¿æ—¶æ¡ä»¶ä¼šé˜»æ­¢æ¨é€ï¼‰
- id: focus_dial_push_tasks_periodic
  alias: "Focus Dial - å‘¨æœŸæ¨é€ä»»åŠ¡åˆ—è¡¨"
  trigger:
    - platform: time_pattern
      minutes: "/15"
  condition:
    - condition: template
      value_template: "{{ state_attr('sensor.focus_dial_status', 'wifi_connected') == true }}"
  action:
    - service: script.focus_dial_send_ticktick_focus_tasks
  mode: single

# Webhook æ¥æ”¶äº‹ä»¶
- id: focus_dial_webhook_events
  alias: "Focus Dial - æ¥æ”¶ webhook äº‹ä»¶"
  description: "å¤„ç† Focus Dial ä¸ŠæŠ¥çš„äº‹ä»¶ï¼šç´¯è®¡ç»Ÿè®¡ + å›å†™ TickTick"
  mode: queued
  max: 10
  trigger:
    - platform: webhook
      webhook_id: focus_dial
      allowed_methods:
        - POST
    # å¯é€‰ï¼šå¦‚æœè®¾å¤‡å›ºä»¶é‡Œå·²ç»å†™æ­»äº†æ—§ webhook_idï¼Œå¯åœ¨è¿™é‡Œå…¼å®¹
    - platform: webhook
      webhook_id: focusdial_910772ca41bc61b2fbf94c466f74d729
      allowed_methods:
        - POST
  variables:
    payload: "{{ trigger.json }}"
    ticktick_project_id: "69510f448f0805fa66144dc9"
    stats_entity: "input_text.focus_dial_stats_today"
    stats: "{{ (states(stats_entity) | default('{}')) | from_json | default({}) }}"
  action:
    - choose:
        # 1. æ­£å¸¸ç»“æŸä¸” count_time=true â†’ ç´¯è®¡ç»Ÿè®¡
        - conditions:
            - condition: template
              value_template: >
                {{ payload.event == 'focus_completed'
                   and (payload.count_time | default(false))
                   and (payload.task_id | default('')) != ''
                   and (payload.elapsed_seconds | default(0) | int) > 0 }}
          sequence:
            - variables:
                task_id: "{{ payload.task_id }}"
                add_seconds: "{{ payload.elapsed_seconds | int }}"
                next_total: "{{ (stats.get(task_id, 0) | int) + add_seconds }}"
                new_stats: "{{ stats | combine({ task_id: next_total }) }}"

            - service: input_text.set_value
              data:
                entity_id: "{{ stats_entity }}"
                value: "{{ new_stats | to_json }}"

            - service: system_log.write
              data:
                message: "Focus Dial: +{{ add_seconds }}s to {{ task_id }} (today={{ next_total }}s)"
                level: info

            # å¯é€‰ï¼šä¸“æ³¨ç»“æŸåç«‹åˆ»åˆ·æ–°ä¸€æ¬¡è®¾å¤‡ä»»åŠ¡åˆ—è¡¨ï¼Œè®© spent_today_sec åŠæ—¶æ›´æ–°
            # - service: script.focus_dial_send_ticktick_focus_tasks

        # 2. ç”¨æˆ·é€‰æ‹©æ ‡è®°å®Œæˆ â†’ å›å†™ TickTick
        - conditions:
            - condition: template
              value_template: >
                {{ payload.event == 'task_done_decision'
                   and (payload.mark_task_done | default(false))
                   and (payload.task_id | default('')) != '' }}
          sequence:
            - service: ticktick.complete_task
              data:
                projectId: "{{ ticktick_project_id }}"
                taskId: "{{ payload.task_id }}"
              continue_on_error: true
              response_variable: complete_response

            - choose:
                - conditions:
                    - condition: template
                      value_template: "{{ complete_response.error is not defined }}"
                  sequence:
                    - service: system_log.write
                      data:
                        message: "Focus Dial: Completed TickTick task {{ payload.task_id }}"
                        level: info
              default:
                - service: persistent_notification.create
                  data:
                    title: "âš ï¸ TickTick å›å†™å¤±è´¥"
                    message: |
                      ä»»åŠ¡ ID: {{ payload.task_id }}
                      ä»»åŠ¡åç§°: {{ payload.task_name }}
                      é”™è¯¯: {{ complete_response.error | default('Unknown error') }}
                    notification_id: "focus_dial_ticktick_error_{{ payload.task_id }}"

                - service: system_log.write
                  data:
                    message: "Focus Dial: Failed to complete TickTick task {{ payload.task_id }}: {{ complete_response.error | default('Unknown') }}"
                    level: error

            # å›å†™åç«‹åˆ»åˆ·æ–°å¹¶é‡æ–°æ¨é€åˆ°è®¾å¤‡ï¼šä»»åŠ¡ä»â€œå¾…åŠâ€æ¶ˆå¤±/è¿›å…¥â€œå·²å®Œæˆâ€
            - delay: "00:00:01"
            - service: script.focus_dial_send_ticktick_focus_tasks
      default: []
```

---
## ç¬¬äº”æ­¥ï¼šé…ç½® Dashboardï¼ˆå¯é€‰ï¼‰

åœ¨ Dashboard æ·»åŠ ä»¥ä¸‹å¡ç‰‡ï¼š

### 1. æ¨é€ä»»åŠ¡æŒ‰é’®

```yaml
type: button
name: ğŸ“‹ ç«‹å³æ¨é€ä»»åŠ¡åˆ° Focus Dial
icon: mdi:clipboard-arrow-right
tap_action:
  action: call-service
  service: script.focus_dial_send_ticktick_focus_tasks
```

### 2. ä»Šæ—¥ç»Ÿè®¡æ˜¾ç¤º

```yaml
type: markdown
content: |
  ## ğŸ“Š Focus Dial ä»Šæ—¥ç»Ÿè®¡

  {% set stats = states('input_text.focus_dial_stats_today') | from_json %}
  {% if stats %}
  {% for task_id, seconds in stats.items() %}
  - **{{ task_id }}**: {{ (seconds / 60) | round(1) }} åˆ†é’Ÿ
  {% endfor %}
  {% else %}
  æš‚æ— ç»Ÿè®¡æ•°æ®
  {% endif %}
title: Focus Dial ä»Šæ—¥ç´¯è®¡
```

### 3. è®¾å¤‡çŠ¶æ€ç›‘æ§

```yaml
type: rest
resource: http://192.168.15.166/api/status
method: GET
scan_interval: 30
value_template: |
  {% if value_json.wifi_connected %}
    åœ¨çº¿ | ä»»åŠ¡åˆ—è¡¨: {{ 'OK' if value_json.tasklist_loaded else 'æœªåŠ è½½' }}
  {% else %}
    ç¦»çº¿
  {% endif %}
```

---
## ç¬¬å…­æ­¥ï¼šç¡®è®¤ TickTick Project IDï¼ˆå¯é€‰ï¼‰

åœ¨ HA å¼€å‘è€…å·¥å…· â†’ æœåŠ¡ï¼Œè°ƒç”¨ï¼š

```yaml
service: ticktick.get_projects
```

ä»è¿”å›çš„ JSON ä¸­æ‰¾åˆ°ä½ çš„ "focus" é¡¹ç›®çš„ `id`ï¼Œä¾‹å¦‚ï¼š

```json
{
  "data": [
    {
      "id": "6987a8plg0rad90bc38b672f",
      "name": "Focus",
      ...
    }
  ]
}
```

æœ¬é¡¹ç›®â€œğŸƒä¸“æ³¨æ¸…å•â€ Project ID å·²ç¡®è®¤ï¼š`69510f448f0805fa66144dc9`ã€‚

---
## ç¬¬ä¸ƒæ­¥ï¼šæµ‹è¯•æµç¨‹

### 1. æµ‹è¯•æ¨é€ä»»åŠ¡åˆ—è¡¨

1. åœ¨ HA å¼€å‘è€…å·¥å…· â†’ æœåŠ¡ï¼Œè°ƒç”¨ï¼š
   ```yaml
   service: script.focus_dial_send_ticktick_focus_tasks
   ```

2. æ£€æŸ¥ Focus Dial è®¾å¤‡ï¼š
   ```bash
   curl http://192.168.15.166/api/status
   ```
   åº”è¯¥æ˜¾ç¤º `tasklist_loaded: true`

3. åœ¨è®¾å¤‡ç©ºé—²ç•Œé¢åŒå‡»æŒ‰é”®ï¼ŒæŸ¥çœ‹ä»»åŠ¡åˆ—è¡¨

### 2. æµ‹è¯•ç»Ÿè®¡ç´¯è®¡

1. åœ¨ Focus Dial é€‰æ‹©ä¸€ä¸ªä»»åŠ¡å¹¶æ­£å¸¸å®Œæˆä¸€æ¬¡è®¡æ—¶
2. æŸ¥çœ‹ HA çš„ `input_text.focus_dial_stats_today` å®ä½“çŠ¶æ€
3. åº”è¯¥çœ‹åˆ°å¯¹åº”ä»»åŠ¡çš„ç§’æ•°å¢åŠ 

### 3. æµ‹è¯• TickTick å›å†™

0. å…ˆä» `todo.zhuan_zhu` çš„ items é‡Œæ‹¿åˆ°ä¸€ä¸ªçœŸå®ä»»åŠ¡ `uid`ï¼ˆ`todo.get_items` è¿”å›é‡Œæœ‰ï¼‰
1. åœ¨ Focus Dial å®Œæˆè®¡æ—¶åï¼Œé€‰æ‹© YESï¼ˆæ ‡è®°å®Œæˆï¼‰
2. æ‰“å¼€ TickTick Appï¼ŒæŸ¥çœ‹ä»»åŠ¡æ˜¯å¦å·²æ ‡è®°å®Œæˆ
3. å¦‚æœå¤±è´¥ï¼ŒHA ä¼šæ˜¾ç¤º persistent notification

---
## æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šæ¨é€ä»»åŠ¡åˆ—è¡¨åè®¾å¤‡æ˜¾ç¤º NO TASKS

**æ£€æŸ¥**ï¼š
1. `curl http://192.168.15.166/api/status` æ˜¯å¦æ˜¾ç¤º `tasklist_loaded: true`
2. HA æ—¥å¿—æ˜¯å¦æœ‰é”™è¯¯ï¼šSettings â†’ System â†’ Logs
3. è„šæœ¬ç”Ÿæˆçš„ `tasks_json` æ˜¯å¦åˆæ³•ï¼ˆåœ¨å¼€å‘è€…å·¥å…·æ¨¡æ¿ç¼–è¾‘å™¨æµ‹è¯•ï¼‰

### é—®é¢˜ 2ï¼šç»Ÿè®¡ä¸ç´¯è®¡

**æ£€æŸ¥**ï¼š
1. webhook æ˜¯å¦æˆåŠŸæ¥æ”¶äº‹ä»¶ï¼šæŸ¥çœ‹ HA æ—¥å¿—
2. `input_text.focus_dial_stats_today` å®ä½“çŠ¶æ€æ˜¯å¦å˜åŒ–ï¼ˆJSON æ˜¯å¦ç´¯åŠ ï¼‰
3. æ—¥å¿—æ˜¯å¦å‡ºç°ï¼š`Focus Dial: +XXs to ...`

### é—®é¢˜ 3ï¼šTickTick å›å†™å¤±è´¥

**æ£€æŸ¥**ï¼š
1. `ticktick_project_id` æ˜¯å¦æ­£ç¡®
2. `payload.task_id` æ ¼å¼æ˜¯å¦åŒ¹é… TickTick çš„ task ID
3. TickTick é›†æˆæ˜¯å¦æ­£å¸¸å·¥ä½œï¼ˆæµ‹è¯• `ticktick.get_projects`ï¼‰
4. æŸ¥çœ‹ HA persistent notification çš„é”™è¯¯ä¿¡æ¯

---
## é…ç½®æ–‡ä»¶ä½ç½®æ€»ç»“

```
/home/zyh/homeassistant/
â”œâ”€â”€ configuration.yaml           # æ·»åŠ  input_text + rest_commandï¼ˆå»ºè®®å†è®¾ç½® internal_url/external_urlï¼‰
â”œâ”€â”€ scripts.yaml                 # æ·»åŠ  focus_dial_send_ticktick_focus_tasks
â””â”€â”€ automations.yaml             # æ·»åŠ  webhook è‡ªåŠ¨åŒ– + æ¯æ—¥æ¸…ç©º + å›å†™
```

---
## ä¸‹ä¸€æ­¥ï¼ˆæ˜æ—© 3 åˆ†é’ŸéªŒæ”¶ï¼‰

1. æ‰“å¼€ HAï¼š`http://192.168.15.194:8123`
2. è°ƒç”¨ `script.focus_dial_send_ticktick_focus_tasks` æ¨é€ä»»åŠ¡åˆ—è¡¨
3. è®¾å¤‡ç©ºé—²ç•Œé¢åŒå‡»åˆ·æ–°ï¼Œç¡®è®¤ä»»åŠ¡å‡ºç°
4. å®Œæˆä¸€æ¬¡ä¸“æ³¨ï¼Œç¡®è®¤ç»Ÿè®¡ç´¯åŠ ï¼›é€‰æ‹© YES éªŒè¯ TickTick è‡ªåŠ¨å®Œæˆ

---

æµ®æµ®é…±ç¥ä¸»äººé…ç½®é¡ºåˆ©å–µï½ à¸…'Ï‰'à¸…
