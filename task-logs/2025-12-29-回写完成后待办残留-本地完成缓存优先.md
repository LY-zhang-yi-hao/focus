# 项目任务日志：回写完成后待办残留（本地完成缓存优先）

日期：2025-12-29  
问题：设备端选择 YES 回写完成后，TickTick App 已显示“已完成”，但 Focus Dial 的“待办”列表仍保留该任务，且“已完成”列表也看不到。

---

## 一、原因分析（与用户对齐）

- `ticktick.complete_task` 已成功执行（TickTick App 已完成）。
- 但 HA 的 TickTick `todo` 实体刷新存在延迟；在回写后立刻调用 `todo.get_items` 时，仍可能拿到旧的“待办缓存”。
- 现有推送逻辑为了避免重复：如果任务还出现在待办列表，会跳过本地“已完成缓存”中的同 ID 任务，导致出现“待办还在 + 已完成不显示”的窗口期。

---

## 二、实施方案（准备怎么做）

### 2.1 合并策略改造：本地完成缓存优先（推荐）

- 在刷新并推送任务列表时：
  - 先读取本地 `completed_tasks` 缓存
  - 对“近期完成”（默认近 2 天）的任务，**从待办列表过滤掉**
  - 再把这些任务以 `status=completed` 的形式下发到设备
- 目的：实现“点 YES 后立刻从待办消失，并进入已完成列表”，不依赖 TickTick `todo` 实体的刷新时序。

### 2.2 兼容性

- 若用户把任务在 TickTick 里“重新打开”为待办：
  - 超过“近期完成”窗口后，将不再强制过滤，任务会重新出现在待办（同时避免与已完成重复显示）。

---

## 三、预期效果（交付标准）

- 设备端选择 YES 回写完成后：
  - 该任务立刻从“待办”列表消失
  - 双击切到“已完成”列表可看到该任务
- 不再需要手动等待 30–60 秒再推送。

---

## 四、实际修改结果（完成后回填）

- 变更文件清单：
  - `custom_components/focus_dial/__init__.py`：仅对“近2天已完成”任务从待办列表本地过滤，并避免与待办重复显示
  - `HOME_ASSISTANT_TICKTICK_FOCUS_DIAL.md`：补充说明“todo 实体刷新延迟 + 本地过滤保证立即生效”
- 关键行为验证结果：
  - Python 语法检查：`python3 -B -m compileall -q custom_components/focus_dial` 通过
