# 任务日志：HA 定时与任务变更推送 + 设备静默接收

- 日期：2025-12-29
- 目标：
  1. 每天早上 07:00 自动推送 TickTick 任务到 Focus Dial
  2. `todo` 清单发生变化时自动推送一次（带防抖，避免短时间连推）
  3. 推送后 **设备不自动跳转** 到任务清单界面（仅更新缓存，用户手动双击进入查看）

## 方案与实现要点（计划）

### A. 固件侧（静默接收）

- 当前固件在收到 `/api/tasklist` 后，如果设备处于 `idle/sleep` 会 `changeState` 切到 `taskListState`。
- 修改为：仅调用 `TaskListState::updateTaskList(...)` 更新任务缓存，不做任何 `changeState`。
- 预期：推送不会打断当前界面；用户仍可在空闲界面双击进入任务列表。

### B. HA 侧（自动推送）

- 在 `/home/zyh/homeassistant/automations.yaml` 新增两条自动化：
  1. `07:00:00` 调用 `focus_dial.push_tasks`
  2. 监听 `todo.zhuan_zhu` 的 `items` 属性变化，防抖延迟后调用 `focus_dial.push_tasks`
- 同时停用旧的“启动后推送/每 15 分钟推送”（避免推送频率不符合需求，且避免旧脚本 ASCII 化导致中文丢失）。

## 预期效果

- 每天 07:00 设备任务列表自动更新（但不切屏）
- TickTick 清单新增/完成/编辑任务后，设备任务列表自动更新（但不切屏）
- 设备界面保持在用户当前页面，只有用户双击才进入任务列表

## 结果（待填写）

- 固件修改：
  - `firmware/src/main.cpp`：收到 `/api/tasklist` 后只更新任务缓存，不再自动 `changeState` 跳转到任务列表（实现“静默接收”）。
- HA 自动化修改：
  - `/home/zyh/homeassistant/automations.yaml`：
    - 新增：每天 `07:00:00` 调用 `focus_dial.push_tasks`
    - 新增：监听 `todo.zhuan_zhu` **状态变化**（该实体不暴露 `items` 属性，通常状态值代表任务数量变化）→ 防抖 3 秒后调用 `focus_dial.push_tasks`
    - 保留：调试用 webhook 触发推送（已改为调用 `focus_dial.push_tasks`，避免旧脚本 ASCII 化导致中文丢失）
    - 移除：启动后推送、每 15 分钟推送（不符合“仅 07:00 + 清单变化”需求）
- 编译/校验：
  - 固件编译：`.venv/bin/pio run -e adafruit_qtpy_esp32` ✅
  - `automations.yaml` YAML 解析校验：✅
- 现场复测：
  - 待你刷入新固件并在 HA 端“重载自动化/重启 HA”后确认：推送只更新缓存，不会自动跳转到任务清单界面。
