# 项目任务日志：项目阅读与规划梳理

- 日期：2025-12-28
- 任务发起：阅读本仓库的代码、文档与现有/后续规划，并给出结构化总结与建议路线图

## 背景与目标

1. 系统性理解项目的技术栈、目录结构、关键模块与运行方式。
2. 汇总仓库中已经存在的“后续规划”线索（如 ROADMAP/TODO/注释标记/文档计划）。
3. 输出一份可执行的迭代路线图（里程碑、优先级、风险点与验证方式）。

## 约束与原则

- 先读后改：本次任务以“阅读与分析”为主，不做业务逻辑改动。
- 可追溯：记录阅读路径、关键结论与引用到的文件位置（用文件路径而非大段粘贴）。
- 最小必要：只提与项目目标、稳定性、可维护性直接相关的建议。

## 执行计划（将要怎么做）

1. 阅读顶层文档与 docs（README、部署/开发说明、变更记录等）。
2. 扫描项目结构与依赖配置（package.json/构建脚本/环境变量）。
3. 定位入口与核心模块（前端/后端/构建链路/关键页面或服务）。
4. 全局检索规划线索（TODO/FIXME/ROADMAP/PLAN/issue 关联文本等）。
5. 汇总输出：项目概览、关键数据流/调用链、风险清单、迭代路线图。

## 预期效果

- 任何新加入的开发者在 10 分钟内理解：项目做什么、怎么跑、核心代码在哪、下一步做什么。
- 对“后续规划/技术债”形成明确优先级，减少重复沟通成本。

## 结果记录（完成后补充）

- 已读文档与入口：
  - `README.md`：项目定位与外部制作教程入口（Instructables/视频）。
  - `platformio.ini`：PlatformIO 构建环境（`adafruit_qtpy_esp32`）、依赖库、分区表。
  - `HOME_ASSISTANT_TICKTICK_FOCUS_DIAL.md`：HA ↔ 设备协议与 YAML 示例（任务下发、webhook 接收、统计累加脚手架）。
  - `FOCUS_DIAL_TICKTICK_HA_总结.md`：方案 B 联动总结、排查清单、手机蓝牙触发建议。
  - `ROADMAP_TickTick_HA_FocusDial.md`：M0~M6 里程碑规划（P0/P1/P2）。
  - `ticktick-integration-checklist.md`：TickTick 集成验证清单（R1/R2/R3）。
  - `hantick-ticktick-integration-analysis.md`：对 Hantick TickTick 集成的适配性分析结论与落地参考。
  - 固件核心入口与实现：`firmware/src/main.cpp`、`firmware/src/controllers/NetworkController.cpp`、`firmware/src/states/*.cpp`。

- 架构与关键模块结论：
  - 项目形态：硬件番茄钟（ESP32）+ Home Assistant 联动中间层 + TickTick 任务源（方案 B）。
  - 固件结构：Controller（显示/输入/LED/网络）+ StateMachine（启动/配网/空闲/选择任务/计时/暂停/完成/确认是否标记完成/休眠/重置）。
  - 对外协议：
    - 设备 HTTP API：`POST /api/tasklist`（HA 下发任务列表）、`GET /api/status`（WiFi/是否加载任务列表）。
    - 设备 → HA：Webhook `POST application/json`（`focus_started/resumed/paused/canceled/completed` + `task_done_decision`），带 `session_id` 便于幂等与去重。
  - 关键数据结构：`FocusTask`（`id/name/display_name/duration/spent_today_sec`）由 HA 生成并下发，设备端只负责展示/选择/计时/上报。

- 已识别的规划线索：
  - 路线图主线已写入 `ROADMAP_TickTick_HA_FocusDial.md`：M1（任务推送闭环）→ M2（今日统计）→ M3（回写 TickTick 完成）→ M4（可观测面板）→ M5（可靠性：去重/重试/断网）→ M6（体验增强）。
  - HA 示例里保留了待办点：`HOME_ASSISTANT_TICKTICK_FOCUS_DIAL.md` 中回写 TickTick 的 service 调用仍是 TODO（需按你选定的 TickTick 集成对接）。
  - TickTick 集成方向：`hantick-ticktick-integration-analysis.md` 给出“满足 R1/R2”的结论与示例调用（`ticktick.complete_task`）。

- 风险与改进建议（以“先跑通→再增强”为原则）：
  - NVS 写入：`firmware/src/states/IdleState.cpp` 中 `IdleState::setTimer()` 使用 `preferences.begin(..., true)`（只读）写入，存在“调整后不落盘”的风险，建议后续修正并检查返回值。
  - 可靠性：webhook 队列容量为 5，网络波动时可能丢事件；建议按 M5 引入基于 `session_id` 的去重与失败告警/重试策略。
  - 安全边界：HTTP API 无鉴权，默认假设在可信局域网；若未来暴露到非可信网段，建议加 token/白名单或反代鉴权。
  - 任务列表体积：JSON 解析缓冲固定（8192），任务过多可能解析失败；建议 HA 侧做“只推 #focus 且限制数量/字段”。

- 建议路线图（里程碑）：
  - 直接以 `ROADMAP_TickTick_HA_FocusDial.md` 为唯一事实来源推进；当前最关键的落地顺序仍是 M1→M2→M3（P0）。
