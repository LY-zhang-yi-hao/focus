# 项目任务日志：中文 OLED + HA .storage 统计（方案 2 稳）

日期：2025-12-29  
目标：**不再依赖拼音/ASCII**，Focus Dial 的 OLED 原生显示中文；HA 侧用自定义组件把统计写入 `.storage`，并在“选择 YES 回写 TickTick 完成”后自动刷新并重新推送任务列表到设备；设备端可查看**待办/已完成**两类列表。

---

## 一、需求确认（已与用户对齐）

1. OLED 必须显示中文任务名与中文界面文案（例如“选择任务 / 是否标记完成”等）。
2. 设备端需要同时看到 **待办列表** 与 **已完成列表**（可切换查看）。
3. 采用方案 2（稳）：HA 自定义组件将统计持久化到 `.storage`（适合长期累加“总学习时长”）。
4. 设备端选择 YES 后：
   - HA 调用 `ticktick.complete_task` 回写完成
   - **立即刷新 TickTick 列表并重新推送到设备**，任务从待办消失并进入已完成（或状态更新）

---

## 二、实施方案（准备怎么做）

### 2.1 固件（OLED 中文）

- 引入 `U8g2_for_Adafruit_GFX` + 中文字体（优先 `wqy` GB2312 字库），在不替换现有 `Adafruit_SSD1306` 的前提下实现中文渲染。
- 全量替换屏幕文案为中文（Idle/Timer/Paused/Reset/Provision/TaskList/Prompt 等）。
- 任务渲染逻辑改为“优先显示 `name`（中文）”，不再因为非 ASCII 而退化成 `TASK xxxx`。

### 2.2 固件（待办/已完成双列表）

- 任务 payload 增加 `status` 字段：`needs_action`（待办）/ `completed`（已完成）。
- 设备端 TaskListState 维护待办/已完成两份列表：
  - **双击**切换“待办/已完成”
  - **单击**在待办列表中开始任务；在已完成列表中仅查看（单击切回待办）
  - **长按**返回空闲

### 2.3 HA 自定义组件（.storage 统计 + 自动刷新推送）

- 新增 `custom_components/focus_dial/`：
  - 使用 `homeassistant.helpers.storage.Store` 把统计写入 `.storage/focus_dial_stats`（含今日/总计）
  - 注册 webhook（默认 `focus_dial`）接收设备事件：
    - `focus_completed` 且 `count_time=true` → 累加统计（今日/总计/按任务）
    - `task_done_decision` 且 `mark_task_done=true` → 调用 `ticktick.complete_task` → 立刻重新拉取 todo 列表并 POST 推送到设备
  - 提供服务：手动 `push_tasks`（刷新并推送）、`reset_today`（可选）

---

## 三、预期效果（交付标准）

- 设备 OLED：
  - TickTick 中文任务名可直接显示（不再是拼音/编号兜底）
  - 关键界面文案均为中文
  - 可切换查看“待办 / 已完成”列表
- HA：
  - 统计数据持久化到 `.storage`，重启不丢失，可长期累加“总学习时长”
  - 设备选择 YES 后，TickTick 任务完成并**立即**在设备列表中更新（待办消失/进入已完成）

---

## 四、验收与自测步骤（完成后执行）

1. 设备端确认中文 UI：空闲页、任务列表、完成确认弹窗均为中文且不乱码。
2. HA 侧触发一次任务推送：设备显示待办/已完成两类任务。
3. 完成一次专注并选择 YES：
   - TickTick App 内任务变为已完成
   - 设备端待办列表立即消失该任务，并能在“已完成”列表看到它（或状态同步）
4. 重启 HA：统计仍存在（`.storage` 持久化有效）。

---

## 五、实际修改结果（待完成后回填）

- 变更文件清单：
  - `platformio.ini`：引入 `U8g2_for_Adafruit_GFX` 依赖
  - `firmware/include/controllers/DisplayController.h`
  - `firmware/src/controllers/DisplayController.cpp`
  - `firmware/include/models/FocusTask.h`
  - `firmware/include/states/TaskListState.h`
  - `firmware/src/states/TaskListState.cpp`
  - `firmware/src/states/TaskCompletePromptState.cpp`
  - `custom_components/focus_dial/manifest.json`
  - `custom_components/focus_dial/const.py`
  - `custom_components/focus_dial/storage.py`
  - `custom_components/focus_dial/__init__.py`
  - `custom_components/focus_dial/services.yaml`
  - `HOME_ASSISTANT_TICKTICK_FOCUS_DIAL.md`
  - `ha-ticktick-focusdial-config.yaml`
  - `FOCUS_DIAL_TICKTICK_HA_总结.md`
  - `ROADMAP_TickTick_HA_FocusDial.md`
  - `TickTick-Integration-Evaluation-Report.md`
- 关键行为验证结果：
  - OLED 中文：固件引入 `U8g2_for_Adafruit_GFX` + `u8g2_font_wqy12_t_gb2312`，并将屏幕文案全量替换为中文；任务名按 UTF-8 安全截断，避免乱码
  - 双列表：payload 支持 `status`（`needs_action/completed`），设备端任务列表**双击切换**“待办/已完成”
  - `.storage`：HA 自定义组件使用 `Store` 持久化统计到 `.storage/focus_dial_stats`，支持长期累加总时长
  - 自动刷新推送：设备上报 `task_done_decision` 后
    - YES：组件调用 `ticktick.complete_task`，随后 `todo.get_items` 刷新并 `POST /api/tasklist` 推送到设备
    - NO：同样刷新推送一次，确保设备端“今日用时/列表”及时同步
  - 语法检查：`python3 -m compileall custom_components/focus_dial` 通过；本环境未安装 `pio/platformio`，未能在仓库内直接编译固件（需在你的 PlatformIO 环境中编译验证）
