# 2025-12-28｜集成状态文档补齐与可用性收尾

**时间**：2025-12-28  
**范围**：仓库文档（不改固件，不改 HA 实机配置）  
**目标**：把仓库内的集成状态文档/配置模板同步到“已在 Home Assistant 实机跑通”的版本，确保明早按文档即可直接使用。

---

## 背景与现状（基于已验证事实）

- HA 可用地址：`http://192.168.15.194:8123`（不依赖 `homeassistant.local`）
- Focus Dial 设备：`http://192.168.15.166`
  - 支持：`GET /api/status`、`POST /api/tasklist`
  - 不支持：`/api/start`、`/api/stop`（设备端返回 404）
- TickTick（Hantick 集成）使用 Todo 实体：`todo.zhuan_zhu`（🎃专注清单）作为任务来源
- 今日统计已采用“自动化内 Jinja 合并 JSON”的方式累计（不使用 `python_script`，避免 import 限制）

---

## 计划（要怎么做）

1. 更新 `TICKTICK-HA-INTEGRATION-STATUS-2025-12-28.md`：
   - 同步 M1/M2/M3 的真实实现（去掉 `python_script` 方案）
   - 修正 `input_text.max`（≤255）与 Focus Dial API 端点说明
   - 更新进度、阻塞点描述与“明早可直接用”的快速检查清单
   - 文档内对 TickTick `Client Secret` 做脱敏（仅保留占位提示）
2. 更新 `ha-ticktick-focusdial-config.yaml`：
   - 用 `todo.get_items` + 清单过滤（不依赖 tags）
   - 去掉 `python_script`，把统计累加写成自动化内 Jinja
   - 同步 webhook ID、Project ID 与测试步骤
3. 全仓检索并清理残留：
   - `python_script.focus_dial_add_seconds` 相关文字/代码块
   - Focus Dial `/api/start`、`/api/stop` 相关说明
   - `input_text.max: 2048` 等错误参数

---

## 预期效果（改完会怎样）

- 文档内容与当前实机配置一致，不会再出现“按文档配了但跑不通”的情况
- 你明早只需要：
  - 访问 HA（IP 地址）；
  - 触发一次“推送任务到设备”（脚本或 webhook）；
  - 在设备上刷新任务列表；
  - 完成一次专注即可看到统计累计，并可选择回写 TickTick 完成

---

## 最终结果（完成后回填）

- [x] 已更新状态文档与模板（同步到“实机已落地”版本）
- [x] 已清理残留内容（移除 `python_script` 方案/错误参数/旧 API 误导）
- [x] 已给出明早快速检查步骤（3 分钟验收清单 + 免鉴权推送 webhook）
- [x] 记录遗留风险与后续优化建议（`input_text` 255 上限、需用真实 UID 做回写验证）

### 具体改动（仓库内）

- 更新 `TICKTICK-HA-INTEGRATION-STATUS-2025-12-28.md`：进度/关键常量/落地配置片段/明早验收清单/脱敏
- 更新 `ha-ticktick-focusdial-config.yaml`：改为 `todo.get_items` + 自动化内 Jinja 统计；去掉 `python_script`
- 更新 `HOME_ASSISTANT_TICKTICK_FOCUS_DIAL.md`：改为 Jinja 统计 + `ticktick.complete_task` 回写；移除 `python_script`
- 更新 `HA-TICKTICK-SETUP-GUIDE.md`：Client Secret 脱敏
- 更新 `hantick-ticktick-integration-analysis.md`、`ROADMAP_TickTick_HA_FocusDial.md`：同步“最终方案不使用 python_script”

### 实机可用性修复（Home Assistant 配置目录）

> 这部分是为了保证“明早开机即可用”，修改发生在 `/home/zyh/homeassistant/`（不在 git 仓库内）。

- 修复 HA → Focus Dial 推送失败（HTTP 400）：
  - 根因：`scripts.yaml` 的 `tasks_json` 模板里混入了 `# ...` 注释行，导致设备端 JSON 解析失败
  - 处理：删除该注释行，确保下发 payload 为纯 JSON
  - 验证：`POST /api/tasklist` 后设备 `GET /api/status` 显示 `tasklist_loaded:true`
- 避免 Recorder 反复告警（UTF-8 surrogate）：
  - 处理：把下发任务里的 `name` 统一设置为 ASCII（与 `display_name` 一致）
  - 结果：推送时不再出现 Recorder “not JSON serializable” 告警
- 增加“自动推送”确保明早免手动：
  - HA 启动后延迟 20 秒自动推送一次任务列表
  - 每 15 分钟周期推送一次（仅在 `sensor.focus_dial_status` 显示在线时）
