# 项目任务日志：已完成任务显示完成日期与专注分钟

日期：2025-12-29  
目标：在 Focus Dial 的“已完成”任务列表中，显示任务的**完成日期（MM.DD）**与**完成当天该任务的累计专注分钟（四舍五入）**，例如：`12.29,专注30min`。

---

## 一、需求确认（已与用户对齐）

1. 数据口径选择 **2**：显示“完成当天该任务的累计专注时长”（不是总累计，也不是仅当次）。
2. 展示方案选择 **方案 2**：HA 推送 payload 增加字段，固件按字段渲染（不把信息硬拼进任务名）。
3. 分钟显示采用**四舍五入**（更贴近“30min”这种表达）。

---

## 二、实施方案（准备怎么做）

### 2.1 HA：本地“已完成任务缓存”增强

- 在 `.storage/focus_dial_stats` 的 `completed_tasks` 条目里新增：
  - `completed_at_mmdd`：完成日期的显示用字符串（如 `12.29`）
  - `completed_spent_sec`：完成当天该任务累计专注秒数（用于固件换算分钟）
- 在写入完成缓存时（收到设备 YES 回写完成后）：
  - 从统计里的 `today_tasks[task_id]` 读取当日累计秒数
  - 记录日期（本地时区）

### 2.2 HA：推送任务列表 payload 增加字段

- 对 `status == completed` 的任务，在下发到设备的 payload 中额外携带：
  - `completed_at`：`MM.DD`（供固件直接显示）
  - `completed_spent_sec`：秒数（供固件四舍五入换算分钟）
- 兼容旧缓存数据：若历史条目没有新字段，则字段留空/为 0，固件做兜底显示。

### 2.3 固件：解析字段并渲染

- `FocusTask` 新增字段：`completedAt` / `completedSpentSeconds`
- JSON 解析时读取 `completed_at` / `completed_spent_sec`（可选字段）
- “已完成”列表底栏改为显示：`{MM.DD},专注{round(min)}min`
  - `min = round(seconds/60)`，实现为 `(seconds + 30) / 60`
  - 若字段缺失则使用兼容兜底显示

---

## 三、预期效果（交付标准）

- 设备端切换到“已完成”列表后，底部信息显示类似：`12.29,专注30min`
- “待办”列表保持现有“今日已专注 xxmin”显示不变
- 历史已完成缓存（未带新字段）不导致崩溃，最多显示为兜底文案

---

## 四、实际修改结果（完成后回填）

- 变更文件清单：
  - `custom_components/focus_dial/storage.py`：完成缓存新增 `completed_at_mmdd` / `completed_spent_sec`，并在写入时从 `today_tasks` 取“完成当天累计秒数”
  - `custom_components/focus_dial/__init__.py`：推送 payload 为已完成任务增加 `completed_at` / `completed_spent_sec`（并兼容旧缓存字段）
  - `firmware/include/models/FocusTask.h`：新增 `completedAt` / `completedSpentSeconds`
  - `firmware/src/states/TaskListState.cpp`：解析 `completed_at` / `completed_spent_sec`（可选字段）
  - `firmware/src/controllers/DisplayController.cpp`：已完成列表底栏显示 `{MM.DD},专注{四舍五入分钟}min`，缺字段时兜底
  - `HOME_ASSISTANT_TICKTICK_FOCUS_DIAL.md`：补充 payload 字段说明与示例
- 关键行为验证结果：
  - Python 语法检查：`python3 -B -m compileall -q custom_components/focus_dial` 通过
  - 固件编译：当前环境未安装 `pio/platformio`，无法在仓库内直接编译验证（需在你的 PlatformIO 环境中编译确认）
