# 专注模式触发与UI优化任务日志

**日期**: 2025-12-29
**状态**: ✅ 已完成

---

## 问题描述

用户反馈以下问题：

1. ~~**双击进入任务列表会触发手机专注模式**~~ - 用户确认问题不存在
2. **选择任务后不能调整时长** - 直接开始计时，无法临时修改
3. **计时完成页UI设计差** - 文字不在框中间，布局不规范
4. **专注中无法查看任务列表** - 希望专注时可以只读查看任务

---

## 实施结果

### ✅ 问题1：双击误触发专注模式
- **结论**：经代码审查确认固件逻辑正确，用户测试后确认问题不存在

### ✅ 问题2：时长调节功能
- **新增文件**：
  - `firmware/include/states/DurationSelectState.h`
  - `firmware/src/states/DurationSelectState.cpp`
- **修改文件**：
  - `TaskListState.cpp` - 单击选择任务后进入 DurationSelectState
  - `StateMachine.h/cpp` - 添加 durationSelectState 静态实例
- **功能**：
  - 默认时长：25分钟
  - 步进：5分钟
  - 范围：5-120分钟
  - 旋钮调节，单击确认开始

### ✅ 问题3：计时完成页UI
- **修改文件**：`DisplayController.cpp:drawDoneScreen()`
- **改进**：
  - "00:00" 居中显示
  - "完成" 标签居中（使用中文字体）
  - 统一框和文字的对齐

### ✅ 问题4：专注中查看任务列表
- **新增文件**：
  - `firmware/include/states/TaskListViewState.h`
  - `firmware/src/states/TaskListViewState.cpp`
- **修改文件**：
  - `TimerState.cpp` - 双击改为查看任务列表，长按改为取消计时
  - `DisplayController.cpp` - 添加 drawTaskListViewScreen()
  - `TaskListState.h` - pendingTasks/completedTasks 改为 public
- **功能**：
  - 只读模式，不能选择任务
  - 不暂停计时、不触发webhook
  - 单击或15秒超时返回计时状态
  - 双击切换待办/已完成列表

---

## 新增交互说明

### 任务列表状态 (TaskListState)
- **旋钮**：滚动选择任务
- **单击**：选择任务 → 进入时长选择
- **双击**：切换待办/已完成列表
- **长按**：取消返回空闲

### 时长选择状态 (DurationSelectState) [新增]
- **旋钮**：调节时长（±5分钟）
- **单击**：确认并开始计时
- **长按**：取消返回任务列表

### 计时状态 (TimerState) [修改]
- **单击**：暂停计时
- **双击**：查看任务列表（只读）[新增]
- **长按**：取消计时 [新增]

### 任务列表查看状态 (TaskListViewState) [新增]
- **旋钮**：滚动查看任务
- **单击**：返回计时状态
- **双击**：切换待办/已完成列表

---

## 编译结果

```
RAM:   [==        ]  21.5% (used 70352 bytes from 327680 bytes)
Flash: [===       ]  29.3% (used 2379721 bytes from 8126464 bytes)
========================= [SUCCESS] Took 2.72 seconds =========================
```
