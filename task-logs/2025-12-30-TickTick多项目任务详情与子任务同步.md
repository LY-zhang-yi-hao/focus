# 任务日志：TickTick 多项目 / 任务详情 / 子任务同步（设备端支持切换与勾选）

- 日期：2025-12-30
- 目标：在不增加设备输入复杂度的前提下，基于 TickTick 官方 Open API（通过 HA 的 `ticktick.*` 服务）扩展 Focus Dial：
  1. 多清单/多项目：设备端可切换项目（双击循环：待办 → 已完成 → 项目选择）
  2. 任务卡片显示：截止时间 / 优先级 / 是否重复 / 是否提醒（紧凑显示）
  3. 已完成任务真实同步：不再依赖本地 completed 缓存作为“已完成列表来源”
  4. 子任务（ChecklistItem）展示与勾选：设备端可勾选子任务、并可标记任务完成
  5. 不做“创建任务”，仅做“更新/完成”

## 约束与确认（来自用户）

- 设备端：
  - 双击循环：待办 → 已完成 → 项目选择
  - 长按：取消/返回空闲（保持原肌肉记忆）
  - 只做展示 + 勾选子任务 + 标记任务完成，不做创建任务
- HA 侧已存在服务：
  - `ticktick.get_projects`
  - `ticktick.get_detailed_project`
  - `ticktick.create_task`（存在但本任务不使用）
  - `ticktick.update_task`
  - `ticktick.complete_task`
- 任务显示范围：
  - 设备显示“当前项目的全部任务”（由 `max_pending / max_completed` 限制数量）
  - 已完成任务：取最近 `max_completed` 条（按 `completedTime` 倒序）

## 设计要点（修改前计划）

### 1) HA 侧（`custom_components/focus_dial`）

- 数据来源从 `todo.get_items` 切换为 TickTick Open API（通过 `ticktick.get_*` 服务拿到完整字段）。
- 推送给设备的 payload 扩展：
  - `projects`: 项目列表（id/name）
  - `selected_project_id` / `selected_project_name`
  - `tasks`: 任务（含 projectId、due、priority、repeat、reminders、items 子任务等）
- webhook 新事件：
  - `project_selected`：设备选中项目后触发，HA 立即拉取该项目并推送刷新
  - `task_complete`：设备请求标记任务完成
  - `subtask_toggle`：设备请求勾选/取消勾选子任务（HA 调 `ticktick.update_task`）

### 2) 设备固件（`firmware`）

- TaskListState / TaskListViewState 增加第三种模式：Project Select
- 任务数据模型扩展：`projectId / due / priority / repeat / reminders / items`
- 新增子任务查看状态：显示子任务列表并支持勾选（通过 webhook 触发 HA 写回）
- UI：
  - 任务卡片紧凑显示：`截止(MM.DD) + 优先级(H/M/L/-) + 重复(R/-) + 提醒(A/-) + 子任务(done/total)`
  - 项目选择页：卡片式项目列表 + 滚动条

## 预期效果

- 设备端可以无感切换不同 TickTick 清单，展示任务完整信息字段。
- 已完成任务列表来自 TickTick 同步结果（真实完成状态），不再依赖本地 completed 缓存“造已完成”。
- 子任务勾选后能写回 TickTick，并在设备端刷新显示。

## 修改结果（修改后补充）

- ✅ 已完成：HA 侧多项目/任务详情/子任务写回
  - 数据来源切换为 TickTick Open API（通过 HA `ticktick.get_projects/get_detailed_project`），推送 payload 包含 `projects + selected_project + tasks(含 due/priority/repeat/reminder/items)`。
  - webhook 支持：
    - `project_selected`：切换项目并立即推送刷新
    - `task_complete`：标记任务完成并刷新推送
    - `subtask_toggle`：勾选/取消勾选子任务（调用 `ticktick.update_task` 更新 items）并刷新推送
    - `task_done_decision`：专注结束“是否标记完成”支持 `project_id`（无则回退到已选项目/默认项目）
  - 存储：新增 `selected_project_id` 持久化（向后兼容）。
- ✅ 已完成：固件侧多模式 UI + 项目选择 + 子任务详情
  - 任务列表模式：双击循环“待办 → 已完成 → 项目选择”，长按保持取消/返回（任务列表状态为返回空闲）。
  - 项目选择页：卡片式项目列表，单击选择后发 `project_selected`。
  - 任务卡片字段展示：截止时间（MM.DD）/优先级（H/M/L）/重复（R）/提醒（A）/子任务进度（done/total）。
  - 新增 `TaskDetailState`：在时长选择页双击进入任务详情，可勾选子任务（`subtask_toggle`）与完成任务（`task_complete`）。
- ✅ 已完成：project_id 贯穿，避免“专注中切项目导致回写错项目”
  - `TimerState / PausedState / TaskCompletePromptState / TaskListViewState` 统一携带 `taskProjectId`，并在 `task_done_decision` payload 里发送 `project_id`。
- ✅ 已完成：设备端 `/api/tasklist` JSON 校验扩容
  - `NetworkController::handleAPITaskList()` 的 JSON 校验缓冲区扩至 `24576`，避免 projects+subtasks payload 误判为 invalid json。
- ✅ 验证
  - HA 组件语法检查：`python3 -m compileall -q custom_components/focus_dial`
  - 固件编译：`.venv/bin/pio run -e adafruit_qtpy_esp32`

## 本次实施步骤（开始修改前记录）

### A) 固件侧（`firmware`）

1. 修复当前编译失败：
   - 对齐 `DisplayController::drawTaskListViewScreen(...)` 的函数签名（补齐 `projectName` 参数）。
   - 实现 `drawProjectSelectScreen(...)` 与 `drawTaskDetailScreen(...)`（此前仅声明未实现）。
2. 贯穿 `project_id` 上下文（避免“专注过程中切换项目 → 结束回写完成时 project 错配”）：
   - `TimerState / PausedState / TaskCompletePromptState / TaskListViewState` 传递并保存 `taskProjectId`。
   - `task_done_decision` webhook payload 增加 `project_id`。
3. 子任务展示与勾选（设备端可写回 TickTick）：
   - 新增 `TaskDetailState`：展示子任务列表、支持单击勾选/取消勾选（发 `subtask_toggle`），并提供“完成任务”（发 `task_complete`）。
   - 入口：在 `DurationSelectState` 增加“双击进入/退出任务详情”（不改变单击开始专注、长按返回任务列表的肌肉记忆）。
4. 扩容设备端 `/api/tasklist` JSON 校验大小：
   - `NetworkController::handleAPITaskList()` 的 `DynamicJsonDocument` 扩至与解析侧一致（>= 24576），避免 projects+subtasks payload 解析失败。
5. 编译验证：
   - `./.venv/bin/pio run -e adafruit_qtpy_esp32`

### B) HA 侧（`custom_components/focus_dial`）

- 保持已完成的 TickTick 服务调用与 webhook 事件处理（多项目/任务字段/真实已完成/子任务写回）。
- 仅在必要时做小修（例如字段兼容/异常兜底），避免扩大范围。

### C) Git 交付

- 完成后补齐“修改结果”并提交到 `main`，执行 `git push` 上传当前代码。
